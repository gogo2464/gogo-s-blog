<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://gogo2464.github.io/docs/js/theme-mode.js></script><link rel=stylesheet href=https://gogo2464.github.io/docs/css/frameworks.min.css><link rel=stylesheet href=https://gogo2464.github.io/docs/css/github.min.css><link rel=stylesheet href=https://gogo2464.github.io/docs/css/github-style.css><link rel=stylesheet href=https://gogo2464.github.io/docs/css/light.css><link rel=stylesheet href=https://gogo2464.github.io/docs/css/dark.css><link rel=stylesheet href=https://gogo2464.github.io/docs/css/syntax.css><title>Episode 1 reverse engineering and exploitation of pokemon red and blue - Gogo's Blog</title>
<link rel=icon type=image/x-icon href=https://gogo2464.github.io/docs/images/favicon.ico><meta name=theme-color content="#1e2327"><meta name=description content="Hello and welcome to my first post. As a first exercise, today we are going to dissect a stack buffer overflow worm present that exploits a vulnerabilty present on the video game pokemon red and blue on gameboy. We will use reverse engineering technics.
I choose to use gameboy because this architecture has no mitigation. It is a perfect example. Also the roms of gameboy are unpatchable. It is the definition of ROM: Read Only Memory."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://gogo2464.github.io/docs/post/episode-1-reverse-engineering-and-exploitation-of-pokemon-red-and-blue/><meta name=twitter:card content="summary"><meta name=twitter:title content="Episode 1 reverse engineering and exploitation of pokemon red and blue - Gogo's Blog"><meta name=twitter:description content="Hello and welcome to my first post. As a first exercise, today we are going to dissect a stack buffer overflow worm present that exploits a vulnerabilty present on the video game pokemon red and blue on gameboy. We will use reverse engineering technics.
I choose to use gameboy because this architecture has no mitigation. It is a perfect example. Also the roms of gameboy are unpatchable. It is the definition of ROM: Read Only Memory."><meta name=twitter:site content="https://gogo2464.github.io/docs/"><meta name=twitter:creator content><meta name=twitter:image content="https://gogo2464.github.io/docs/"><meta property="og:type" content="article"><meta property="og:title" content="Episode 1 reverse engineering and exploitation of pokemon red and blue - Gogo's Blog"><meta property="og:description" content="Hello and welcome to my first post. As a first exercise, today we are going to dissect a stack buffer overflow worm present that exploits a vulnerabilty present on the video game pokemon red and blue on gameboy. We will use reverse engineering technics.
I choose to use gameboy because this architecture has no mitigation. It is a perfect example. Also the roms of gameboy are unpatchable. It is the definition of ROM: Read Only Memory."><meta property="og:url" content="https://gogo2464.github.io/docs/post/episode-1-reverse-engineering-and-exploitation-of-pokemon-red-and-blue/"><meta property="og:site_name" content="Episode 1 reverse engineering and exploitation of pokemon red and blue"><meta property="og:image" content="https://gogo2464.github.io/docs/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-08-05 21:09:23 +0200 +0200"></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://gogo2464.github.io/docs/><img class=octicon height=32 width=32 src></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'>
<img height=24 class="octicon octicon-three-bars" width=24 src></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=UTF-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://gogo2464.github.io/docs/></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://gogo2464.github.io/docs/><img class="octicon octicon-mark-github v-align-middle" height=32 width=32 src></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://gogo2464.github.io/docs/><img class=avatar-user src=https://avatars.githubusercontent.com/u/15933322 width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://gogo2464.github.io/docs/></a></span><span class=path-divider>/</span>
<strong class="css-truncate css-truncate-target mr-1" style=max-width:410px><a href=https://gogo2464.github.io/docs/post/episode-1-reverse-engineering-and-exploitation-of-pokemon-red-and-blue/>Episode 1 reverse engineering and exploitation of pokemon red and blue</a></strong></h1><div class="note m-0">Created <relative-time datetime="Fri, 05 Aug 2022 21:09:23 +0200" class=no-wrap>Fri, 05 Aug 2022 21:09:23 +0200</relative-time>
<span class=file-info-divider></span>
Modified <relative-time datetime="Mon, 17 Jun 2024 12:00:32 +0000" class=no-wrap>Mon, 17 Jun 2024 12:00:32 +0000</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>1799 Words</div><div class="file-actions flex-order-2 pt-0"></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>Hello and welcome to my first post. As a first exercise, today we are going to dissect a stack buffer overflow worm present that exploits a vulnerabilty present on the video game pokemon red and blue on gameboy. We will use reverse engineering technics.</p><p>I choose to use gameboy because this architecture has no mitigation. It is a perfect example. Also the roms of gameboy are unpatchable. It is the definition of ROM: Read Only Memory. Then we could have friend with consentent friend to play with them and show them the exploit.</p><p>The goal is to understand how the worm works and then to modify the worm to make it &ldquo;better&rdquo;&mldr; Or worst, depends of what you expect.</p><p>I/Install tools.</p><p>First we are going to install the tools to be able to reverse engineer the malware. The full script is here:</p><pre tabindex=0><code>sudo apt install cmake make gcc git -y;
sudo apt install pkg-config libpng-tools libpng-dev bison -y;

git clone https://github.com/radareorg/radare2;
sh ./radare2/sys/install.sh;

git clone https://github.com/gbdev/rgbds;
cmake -S . -B rgbds/build/ -DCMAKE_BUILD_TYPE=Release rgbds/;
cmake --build rgbds/build;
sudo cmake --install rgbds/build;
sudo make install -C rgbds;

git clone https://github.com/pret/pokered;
make -C pokered/;

git clone https://github.com/MrCheeze/pokered-self-replicator;
mv pokered-self-replicator/sav.dat pokered/pokered.sav;

wget https://bgb.bircd.org/bgbw64.zip;
mkdir bgb;
unzip bgbw64.zip -d bgb;

sudo dpkg --add-architecture i386
sudo wget -nc -O /usr/share/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
sudo wget -nc -P /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/debian/dists/bullseye/winehq-bullseye.sources
sudo apt update
sudo apt install --yes --install-recommends winehq-devel

wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;
</code></pre><p>Copy it in a file. Name it install.sh and then open an terminal and do <code>sh ./install.sh</code>.</p><p>The script installs radare2. It is a framwork of reverse engineering. A reverse engineering framwork is a tool to dissect malware. But you can also dissect any file.</p><p>Then it installs the game boy rom compiler RGBDS.</p><p>After the script install and compile the documented rom of pokemon red and blue. This repository is an unofficial repository made to document the internals of the game pokemon red and blue. It has been created by the community to make games derivated from the original game (mods).</p><p>Then it install the current work on the virus that we want to dissect: <a href=https://github.com/MrCheeze/pokered-self-replicator>https://github.com/MrCheeze/pokered-self-replicator</a></p><p>Then it installs bgb emulator. It is free but sadly not free software (libre) but it works&mldr; I plan to replace it with Emulicious to connect it with radare2 in the future. Then I will even replace Emulicious by Sameboy and then connect radare2 to SameBoy.</p><p>Wine is the windows Emulator. yes I use an emulator to emulate an emulator. It is pretty dirty. As I told I plan to remove it.</p><p>If the script works finely, you will the a screen with a game. You should hear sounds from the game also. Then it is ok.</p><p>II/Run the virus.</p><p>Let&rsquo;s start by running the virus to see what it does. The command <code>mv pokered-self-replicator/sav.dat pokered/pokered.sav;</code> has moved and renamed the save file as the root directory of the disassembly to use the save file of the game. The script has started the virus. You can run it again at any moment. Go in the directory installed and do: <code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;</code></p><p>According to the blog of the virus at <a href=https://github.com/MrCheeze/pokered-self-replicator>https://github.com/MrCheeze/pokered-self-replicator</a> when you exchange a pokemon, the receiver will caught a virus. So let&rsquo;s do it.</p><p>So open two terminals:</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;</code></p><p>and</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokeblue.gbc;</code>.</p><p>Then you have two choices. Either you plan the game until you are able to go to the nurse to exchange the pokemon. Or you use a save file to go directly to the location of the nurse. In this book, we will of course choose the second option.</p><p>So to download the save file do <code>git clone https://github.com/gogo2464/pokemon-blue-save-file;</code></p><p>then put the file <code>pokeblue.sav</code> in the folder <code>pokered</code>.</p><p>So once again, open the two terminals:</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;</code></p><p>and</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokeblue.gbc;</code>.</p><p>You will be in the location just on the Nurse. In BGB, select one game, right click on the screen, go to link/listen/click ok. Select the other game, right click on the screen, go to link/connect/click ok.</p><p>The games will be slower but it is ok. Go to the nurse and then exchange the pokemon. As the documentation of the worm tell, you should see weird characters on the games. It is exactly what is expected.</p><p>III/Document the virus.</p><p>Here comes the interesting part. We are going to dissect the virus to understand how it works in order to modify it. We already know from the official virus documentation that the virus infects save file. Then to read content of the save file, do: <code>radare2 -a gb -e cfg.bigendian=false -e cfg.charset=pokered pokered.sav;</code></p><p><code>radare2</code> is the framework of reverse engineering that we use to dissect the virus.</p><p>The option <code>-a gb</code> tell to radare2 to disassemble the content of the file as gameboy machine code. machine code is code that has been compiled by a programming language like C. It should be understood only by computers, not programmers but can be also be understood by reversers with right tools.</p><p>The option <code>-e cfg.bigendian=false</code> set the endianess of the program to little endian. It tell to radare2 how works the gameboy architecture to let it show it&rsquo;s real internals.</p><p>The option <code>-e cfg.charset=pokered</code> tell to radare2 how to understand data that represent printable text values.</p><p>Now in the interpreter (<code>[0x00000000]></code>), type <code>V</code> and enter. You can scroll with the arrow keys of the keyboard to see the data of the save file. These are the values stored by the game to save progression. Some players have documented the save file. You can read the doc <a href=https://bulbapedia.bulbagarden.net/wiki/Save_data_structure_(Generation_I)>of the community driven pokemon red and blue save file here</a>.</p><p>Now type <code>p</code> in the screen of radare2. You will see assembly language. The famous machine code. From now you can scroll on any point of the save file that has been presented in the virus documentation. See <a href=https://github.com/MrCheeze/pokered-self-replicator>this link</a>.</p><p>Today we will focus on the code located at the offset (the address in the file) at 0x3540. Then raise a console by typing <code>:</code> in the radare2 screen. Now, in the console, do <code>s 0x3540</code>. <code>q</code> to leave the console and to come back in visual mode. You should see code that starts by:</p><pre tabindex=0><code>xor a
ld [0xcf92], a
ld hl, 0xda80
ld [hl], 0x14
xor a
ld [0xcca2], a
call 0x190f
call 0x20af
call 0x019a
ld a, 0xf6
ld bc, 0x0032
ld de, 0xffd3
ld hl, 0xc3b6
ld [hl], 0xf6
inc hl
ld [hl], a
add hl, bc
ld [hl], a
dec hl
ld [hl], 0xf7
add hl, de
inc a
jr nZ, 0xf3

...
</code></pre><p>Here we are!</p><p>It is generally better to know an assembly language programming. We will teach everything about assembly language in this book but if you are really lost when reading assembly code, you can learn the very common x86_32 <a href=http://pacman128.github.io/pcasm/>Here</a>. It is not a waste of time because you will need it latter when you will have to work on a modern architecture for a real exploitation script.</p><p>As told in the documentation of the virus, we are located at 0x3540, the offset of the object 8f. According to the documentation, the 8f object is an object that the virus let in the inventory of the victim once the victim is infected. It allow the victim to get any pokemon of the victim choice.</p><p>So basically, if we modify the save file at this offset, we can change the payload of the virus. Make a copy of the pokered.sav file. We are now going to modify the payload.</p><p>IV/Edit the virus.</p><p>Leave radare2 with the command <code>q</code>. Reopen it with: <code>radare2 -a gb -e cfg.bigendian=false -e cfg.charset=pokered -s 0x3540 -w pokered.sav;</code>.</p><p>The option <code>s 0x3540</code> means that radare2 seeks at the offset 0x3540 at the openning of the file.</p><p>The option <code>-w</code> ask radare2 to open the file in write mode. It allows us to modify the file. If do not set it, then we can not patch it.</p><p>Then once you are at the offset 0x3540, you can patch the 8f object with the command &ldquo;wa &lt;instruction 1>; &lt;instruction 2>; etc&mldr;&rdquo;. All the technic not related to tools consists now to write your own asm code to patch the object. Let&rsquo;s do an example.</p><p>Read the disassembly of pokemon red and blue.</p><p>As you can read. There is a assembly routine (it is the name for an assembly function) where PlaySound is defined. See <a href=https://github.com/pret/pokered/blob/2954013da1f10e11db4ec96f9586b7c01706ae1a/home/audio.asm#L140>here</a>.</p><p>Sadly for the purpose of the virus, the routine must be called by it&rsquo;s offset. Not by routine name. In the current version of radare2 used in this tutorial (</p><pre tabindex=0><code class=language-$ data-lang=$>radare2 5.7.7 28577 @ linux-x86-64 git.5.7.6-11-gdc2862970
commit: dc2862970735c473770adedf17792669bf2a2f04 build: 2022-08-05__22:59:00
</code></pre><p>), radare2 does not analyses symbols yet. So open the ROM pokered.gbc with the command <code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;</code>. Left click in the bgb emulator and then type <code>esc</code>. Right click > go to > type <code>PlaySound:</code></p><p>Then you should see that: <img src=/gogo-s-blog/images/episode-1-reverse-engineering-and-exploitation-of-pokemon-red-and-blue/bgb-screenshot-censored.png alt=image></p><p>The highligthed instruction is <code>PlaySound</code>, and contains the offset that we must rely on. The offset is 0x23b1.</p><p>According to the pokered documentation:</p><pre tabindex=0><code>; plays music specified by a. If value is $ff, music is stopped
</code></pre><p>So we have to find the value of a to put the music of our choice.</p><p>After reading the source code of pokered, we can read <a href=https://github.com/pret/pokered/blob/6b5be9129cabe72b9f775b02db1bf7e7169153da/constants/music_constants.asm#L17>the value of a value for the lavender music</a>. As a macro, you can modify the source code of pokered and write:</p><pre tabindex=0><code>PRINTT &#34;The value of lavender a value is: &#34;
PRINTT &#34;{MUSIC_LAVENDER}&#34;
PRINTT &#34;\n&#34;
</code></pre><p>At <a href=https://github.com/pret/pokered/blob/6b5be9129cabe72b9f775b02db1bf7e7169153da/constants/music_constants.asm#L18>this line</a> to debug.</p><pre tabindex=0><code>The value of lavender a value is: 0xd4
</code></pre><p>We have the value 0xd4 !</p><p>So if we replace the code at the offset 0x3540 by</p><pre tabindex=0><code>ld a, 0xd4
call 0x23b1 ;PlaySound
ret
</code></pre><p>The instruction <code>ld a, 0xd4</code> put the value 0xd4 in the register a. In assembly language a register is a specific place to remember a value. For example in gameboy assembly, the register <code>pc</code> remember the value of the instruction currently executed and move to another instruction when the value is changed.</p><p>The instruction <code>call 0x23b1</code> calls the routine at offset 0x23b1. Here is is <code>PlaySound</code>.</p><p>The instruction <code>ret</code> leaves the routine previously called: it more specifically get the value of the register pc <code>pc</code> saved previously by <code>call</code> and jump to it.</p><p>the 8f object will play a creepy music!</p><p>So to do that, in the install directory, do:</p><pre tabindex=0><code>radare2 -a gb -e cfg.fortunes=false -e cfg.bigendian=false -e cfg.charset=pokered -s 0x3540 -w ./pokered/pokered.sav;
&#34;wa ld a, 0xd4; call 0x23b1; ret;&#34;
q
</code></pre><p>The option <code>-e cfg.fortunes=false</code> disables the tips for radare2. It is more convenient.</p><pre tabindex=0><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;
</code></pre><p>type <code>enter > items > s > 8f</code>.</p><p>The creepy music should comes&mldr; Congratulation! You just have patched the payload of the mister cheeze virus. Now you can modify the assembly by yourself and put what you want! Be creative!</p></article></div></div></div></div></div></div></main></div><script type=application/javascript src=https://gogo2464.github.io/docs/js/toc.js></script><link rel=stylesheet href=https://gogo2464.github.io/docs/css/toc.css><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://gogo2464.github.io/docs/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://gogo2464.github.io/docs/js/github-style.js></script></html>