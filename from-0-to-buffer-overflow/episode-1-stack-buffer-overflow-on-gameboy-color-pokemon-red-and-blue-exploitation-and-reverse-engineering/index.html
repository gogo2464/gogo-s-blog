<!doctype html><html lang=en-us><head><title>Episode 1 Stack Buffer Overflow on Gameboy Color Pokemon Red and Blue Exploitation and Reverse Engineering | Gogo's Blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Hello and welcome to my first post. As a first exercise, today we are going to dissect a stack buffer overflow worm present that exploits a vulnerabilty present on the video game pokemon red and blue on gameboy. We will use reverse engineering technics.
I choose to use gameboy because this architecture has no mitigation. It is a perfect example. Also the roms of gameboy are unpatchable. It is the definition of ROM: Read Only Memory."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>←</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a></nav><main class=main><section id=single><h1 class=title>Episode 1 Stack Buffer Overflow on Gameboy Color Pokemon Red and Blue Exploitation and Reverse Engineering</h1><div class=tip><time datetime="2022-08-05 21:09:23 +0200 +0200">Aug 5, 2022</time>
<span class=split>·</span>
<span>1137 words</span>
<span class=split>·</span>
<span>6 minute read</span></div><div class=content><p>Hello and welcome to my first post. As a first exercise, today we are going to dissect a stack buffer overflow worm present that exploits a vulnerabilty present on the video game pokemon red and blue on gameboy. We will use reverse engineering technics.</p><p>I choose to use gameboy because this architecture has no mitigation. It is a perfect example. Also the roms of gameboy are unpatchable. It is the definition of ROM: Read Only Memory. Then we could have friend with consentent friend to play with them and show them the exploit.</p><p>The goal is to understand how the worm works and then to modify the worm to make it &ldquo;better&rdquo;&mldr; Or worst, depends of what you expect.</p><p>I/Install tools.</p><p>First we are going to install the tools to be able to reverse engineer the malware. The full script is here:</p><pre tabindex=0><code>sudo apt install cmake make gcc git -y;
sudo apt install pkg-config libpng-tools libpng-dev bison -y;

git clone https://github.com/radareorg/radare2;
sh ./radare2/sys/install.sh;

git clone https://github.com/gbdev/rgbds;
cmake -S . -B rgbds/build/ -DCMAKE_BUILD_TYPE=Release rgbds/;
cmake --build rgbds/build;
sudo cmake --install rgbds/build;
sudo make install -C rgbds;

git clone https://github.com/pret/pokered;
make -C pokered/;

git clone https://github.com/MrCheeze/pokered-self-replicator;
mv pokered-self-replicator/sav.dat pokered/pokered.sav;

wget https://bgb.bircd.org/bgbw64.zip;
mkdir bgb;
unzip bgbw64.zip -d bgb;

sudo dpkg --add-architecture i386
sudo wget -nc -O /usr/share/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
sudo wget -nc -P /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/debian/dists/bullseye/winehq-bullseye.sources
sudo apt update
sudo apt install --install-recommends winehq-devel

wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;
</code></pre><p>Copy it in a file. Name it install.sh and then open an terminal and do <code>sh ./install.sh</code>.</p><p>The script installs radare2. It is a framwork of reverse engineering. A reverse engineering framwork is a tool to dissect malware. But you can also dissect any file.</p><p>Then it installs the game boy rom compiler RGBDS.</p><p>After the script install and compile the documented rom of pokemon red and blue. This repository is an unofficial repository made to document the internals of the game pokemon red and blue. It has been created by the community to make games derivated from the original game (mods).</p><p>Then it install the current work on the virus that we want to dissect: <a href=https://github.com/MrCheeze/pokered-self-replicator target=_blank rel=noopener>https://github.com/MrCheeze/pokered-self-replicator</a></p><p>Then it installs bgb emulator. It is sadly not a free software but it works&mldr; I plan to replace it with Emulicious in the future.</p><p>Wine is the windows Emulator. yes I use an emulator to emulate an emulator. It is pretty dirty. As I told I plan to remove it.</p><p>If the script works finely, you will the a screen with a game. You should hear sounds from the game also. Then it is ok.</p><p>II/Run the virus.</p><p>Let&rsquo;s start by running the virus to see what it does. The command <code>mv pokered-self-replicator/sav.dat pokered/pokered.sav;</code> has moved and renamed the save file as the root directory of the disassembly to use the save file of the game. The script has started the virus. You can run it again at any moment. Go in the directory installed and do: <code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;</code></p><p>According to the blog of the virus at <a href=https://github.com/MrCheeze/pokered-self-replicator target=_blank rel=noopener>https://github.com/MrCheeze/pokered-self-replicator</a> when you exchange a pokemon, the receiver will caught a virus. So let&rsquo;s do it.</p><p>So open two terminals:</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;</code></p><p>and</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokeblue.gbc;</code>.</p><p>Then you have two choices. Either you plan the game until you are able to go to the nurse to exchange the pokemon. Or you use a save file to go directly to the location of the nurse. In this book, we will of course choose the second option.</p><p>So to download the save file do <code>git clone https://github.com/gogo2464/pokemon-blue-save-file;</code></p><p>then put the file <code>pokeblue.sav</code> in the folder <code>pokered</code>.</p><p>So once again, open the two terminals:</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokered.gbc;</code></p><p>and</p><p><code>wine64 $(pwd)/bgb/bgb64.exe $(pwd)/pokered/pokeblue.gbc;</code>.</p><p>You will be in the location just on the Nurse. In BGB, select one game, right click on the screen, go to link/listen/click ok. Select the other game, right click on the screen, go to link/connect/click ok.</p><p>The games will be slower but it is ok. Go to the nurse and then exchange the pokemon. As the documentation of the worm tell, you should see weird characters on the games. It is exactly what is expected.</p><p>III/Document the virus.</p><p>Here comes the interesting part. We are going to dissect the virus to understand how it works in order to modify it. We already know from the official virus documentation that the virus infects save file. Then to read content of the save file, do: <code>radare2 -a gb -e cfg.bigendian=false -e cfg.charset=pokered pokered.sav;</code></p><p><code>radare2</code> is the framework of reverse engineering that we use to dissect the virus.</p><p>The option <code>-a gb</code> tell to radare2 to disassemble the content of the file as gameboy machine code. machine code is code that has been compiled by a programming language like C. It should be understood only by computers, not programmers but can be also be understood by reversers with right tools.</p><p>The option <code>-e cfg.bigendian=false</code> set the endianess of the program to little endian. It tell to radare2 how works the gameboy architecture to let it show it&rsquo;s real internals.</p><p>The option <code>-e cfg.charset=pokered</code> tell to radare2 how to understand data that represent printable text values.</p><p>Now in the interpreter (<code>[0x00000000]></code>), type <code>V</code> and enter. You can scroll with the arrow keys of the keyboard to see the data of the save file. These are the values stored by the game to save progression. Some players have documented the save file. You can read the doc <a href=https://bulbapedia.bulbagarden.net/wiki/Save_data_structure_%28Generation_I%29 target=_blank rel=noopener>of the community driven pokemon red and blue save file here</a>.</p><p>Now type <code>p</code> in the screen of radare2. You will see assembly language. The famous machine code. From now you can scroll on any point of the save file that has been presented in the virus documentation. See <a href=https://github.com/MrCheeze/pokered-self-replicator target=_blank rel=noopener>this link</a>.</p><p>Today we will focus on the code located at the offset (the address in the file) at 0x3540. Then raise a console by typing <code>:</code> in the radare2 screen. Now, in the console, do <code>s 0x3540</code>. <code>q</code> to leave the console and to come back in visual mode. You should see code that starts by:</p><pre tabindex=0><code>xor a
ld [0xcf92], a
ld hl, 0xda80
ld [hl], 0x14
xor a
ld [0xcca2], a
call 0x190f
call 0x20af
call 0x019a
ld a, 0xf6
ld bc, 0x0032
ld de, 0xffd3
ld hl, 0xc3b6
ld [hl], 0xf6
inc hl
ld [hl], a
add hl, bc
ld [hl], a
dec hl
ld [hl], 0xf7
add hl, de
inc a
jr nZ, 0xf3

...
</code></pre><p>Here we are!</p><p>It is generally better to know an assembly language programming. We will teach everything about assembly language in this book but if you are really lost when reading assembly code, you can learn the very common x86_32 <a href=http://pacman128.github.io/pcasm/ target=_blank rel=noopener>Here</a>. it is not a waste of time because you will need it latter when you will have to work on a modern architecture for a real exploitation script.</p></div></section></main><footer id=footer><div class=copyright>© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span></div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>